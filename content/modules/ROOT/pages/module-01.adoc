:numbered:

= Convert To RHEL with Azure Arc

== Overview
In this workshop you will convert a Centos 7 system into a Red Hat Enterprise Linux 7 system.

This lab has two Centos VMs: One Apache and one Mysql.

In this lab you will:

* Install the Azure Arc client on both Centos VMs
* Convert2Rhel both Centos VMs
* Reboot VMs
* Validate the Web App still work
* Discuss security and conversion technical issues



== Lab Access

. Access your *httpd server VM* with the following command.
+
[source,bash,subs="attributes",role=execute]
----
{web_host_ssh_command}
----
+
.`devops` user password
[source,bash,subs="attributes",role=execute]
----
{web_host_ssh_password}
----

. Access your *database server VM* with the following command.
+
[source,bash,subs="attributes",role=execute]
----
{database_host_ssh_command}
----
+
.`devops` user password
[source,bash,subs="attributes",role=execute]
----
{database_host_ssh_password}
----

== Verify the Web App is Running

. Browse to http://{web_app_url}[Sample Web App] to verify the web app is running.
+
.Sample Output
----
id: 1 - Word: example 83
----

== Run Azure Arc Commands on Both VMs

Azure Arc enables the managment and monitoring of infrastrucutre such as RHEL Servers and OpenShift deployemnts that are deployed on-premsies or in mulit-cloud enviroments. For this lab we pre-created the installation script using a service principal that will connect the AWS VM to Azure Arc. Once the script is executed, the connected VM will display in the Azure portal.

. Switch to root user.
+
[source,bash,role=execute]
----
sudo -i
----

. Change into the home directory of root
+
[source,bash,role=execute]
----
cd /root
----

. Execute the Arc connection sript named deploy_arc.sh
+
[source,bash,role=execute]
----
./deploy_arc.sh
----

The azcmagent-1.39.02628-1431.x86_64 will be installed and the VM Arc resource will be associated with the resource group called RedHatSummmit2024. You can verify the agent and its depednacies are installed in the /opt/azcmagent/bin folder.

== Run the Convert2RHEL Commands on Both VMs

Now we'll actually do the Centos to RHEL conversion.

=== Enabling the Convert2RHEL repository

The Convert2RHEL RPM is an offical Red Hat package. 
Therefore it is readily availble from the Red Hat software repository (CDN). 
As your CentOS server is not subscribed to the Red Hat CDN, you will need to enable the Convert2RHEL repository.

. Get the GPG signing key
+
[source,bash,role=execute]
----
curl -o /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release https://www.redhat.com/security/data/fd431d51.txt
----

. Download the SSL certificate
+
[source,bash,role=execute]
----
curl --create-dirs -o /etc/rhsm/ca/redhat-uep.pem https://ftp.redhat.com/redhat/convert2rhel/redhat-uep.pem
----

. Download the convert2rhel repository file
+
[source,bash,role=execute]
----
curl -o /etc/yum.repos.d/convert2rhel.repo https://ftp.redhat.com/redhat/convert2rhel/7/convert2rhel.repo
----

=== Installing the Convert2RHEL utility
 
Now that the requisite repository is enabled on your CentOS Linux system, it is time to install the Convert2RHEL utility and prepare the system for conversion.

. Before you begin the installation process, verify that you are running CentOS Linux and on the latest minor version.
+
[source,bash,role=execute]
----
cat /etc/centos-release
----

. Verify that the Convert2RHEL repo is enabled.
+
[source,bash,role=execute]
----
yum repolist
----

. Install the convert2rhel utility.
+
[source,bash,role=execute]
----
yum install -y convert2rhel
----

== Run the Convert2RHEL utility

. Before running the Convert2RHEL utility, you need to tell it to ignore the unknown or incompatible kernel modules.
The Microsoft kernel modules are not known to the conversion system.
Execute the following to put the override flag into your environment permanently.
+
[source,bash,role=execute]
----
echo "export CONVERT2RHEL_ALLOW_UNAVAILABLE_KMODS=1" >> ~/.bashrc
----

. In order to automate this process, you need to use activation key in the conversion command.
+
[source,bash,role=execute]
----
convert2rhel --org 12451665 --activationkey convert2rhel -y
----
+
NOTE: This process takes some time! The above process ask to confirm at several steps. Adding a `-y` as an argument will automate the input. 

. Now that the conversion has been deployed successfully, you will need to reboot the system in order to put the changes into effect.
+
[source,bash,role=execute]
----
reboot
----

. Verify the system is running on Red Hat Enterprise Linux.
+
[source,bash,role=execute]
----
cat /etc/redhat-release
----

. Verify that the necessary Red Hat repositories are enabled. Also, note that none of the old CentOS repos are available.
+
[source,bash,role=execute]
----
yum repolist
----

. Now you can review the logs from the conversion itself.
+
[source,bash,role=execute]
----
less /var/log/convert2rhel/convert2rhel.log
----

. Verify the Web Application still functions by browsing to http://{web_app_url}[Sample Web App] to verify the web app is running.
+
.Sample Output
----
id: 1 - Word: example 83
----

== Congratulations!

You have converted from Centos to RHEL, and it's displayed in Arc on the instrucot main screen.

. Optional Lab

Log into Azure portal.

NOTE: In order to log into the Azure portal, you will need user crednetials which you can obtain from lab instrucotr or lab team mates.

. Logging into the Azure portal requires the use of Azure Authenticator which can be installed on your mobile device.
. Once logged into the Azure portal you can navigate to a few key areas
.. Arc resource blade and find the Infrastrcutre section and click on Machines to find your VM's connected via Azure Arc

image::Azure_Arc_Portal.jpg[Azure,55%,55%]

. Notes from the field:

* Convert2Rhel fails with 3rd party software.
** Solution: `echo "CONVERT2RHEL_ALLOW_UNAVAILABLE_KMODS=1" >> ~/.bashrc`
